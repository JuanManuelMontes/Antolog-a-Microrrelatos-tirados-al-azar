<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Triple C - Microrrelatos al Azar</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b0f17;
    --fg:#eaf2ff;
    --muted:#9fb2d9;
    --btn:#1d5cff;
    --btn-hover:#1647c8;
    --card:#121826;
    --edge:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100dvh; display:grid; place-items:center;
    background:
      radial-gradient(1200px 700px at 10% -10%, #15203a 0%, transparent 60%),
      radial-gradient(1200px 700px at 110% 110%, #0e1526 0%, transparent 60%),
      var(--bg);
    color:var(--fg);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  }
  .app{ width:min(1080px,94vw); display:grid; gap:28px; padding:16px; }
  header h1{margin:0 0 4px; font-weight:800; letter-spacing:.3px}
  header p{margin:0; color:var(--muted)}
  .stage{ display:grid; grid-template-columns:1fr 1fr; gap:28px; align-items:start; }
  
  @media (max-width:880px){ 
    .stage{ grid-template-columns:1fr } 
  }
  @media (max-width: 480px) {
    body { font-size: 15px; }
    .app { padding: 12px; }
  }

  .dice-wrap{
    display:grid; gap:16px; place-items:center; padding:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    border-radius:16px; outline:1px solid var(--edge);
  }
  
  .dice-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-bottom: 6em; 
  }
  
  .viewport{
    width: 100%;
    max-width: 10em;
    aspect-ratio:1/1;
    perspective: 60em;
    display:grid;
    place-items:center;
    position:relative;
    margin: 0 auto;
    transform: scale(0.9); 
  }
  
  .shadow{ position:absolute; bottom:2%; width:70%; height:12%; background:radial-gradient(50% 60% at 50% 50%, rgba(0,0,0,.55), rgba(0,0,0,0) 70%); filter:blur(4px); pointer-events:none; }
  .dice{
    width:77%; height:77%;
    position:relative; transform-style:preserve-3d;
    transition:transform 1.05s cubic-bezier(.2,.7,.1,1); will-change:transform;
  }
  .face{
    position:absolute; inset:0;
    background:radial-gradient(160% 120% at 50% 20%, #2b3a63 0%, #1f2a47 55%, #141b2d 100%);
    border-radius: 0.75em;
    display:grid; place-items:center;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.05), inset 0 1.5em 3.75em rgba(255,255,255,.08), 0 1.5em 3.75em rgba(0,0,0,.55);
  }
  .face::after{
    content:""; position:absolute; inset:-1px; 
    border-radius: 0.75em;
    background:linear-gradient(to bottom right, rgba(255,255,255,.10), rgba(255,255,255,0) 30%), radial-gradient(80% 60% at 30% 10%, rgba(255,255,255,.15), transparent 60%);
    mix-blend-mode:screen; pointer-events:none;
  }
  .edge{ position:absolute; inset:0; 
    border-radius: 0.75em;
    box-shadow:0 0 0 2px rgba(255,255,255,.05); pointer-events:none; 
  }
  
  .pips {
    width: 64%; height: 64%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);  
    grid-template-rows: repeat(3, 1fr);  
    gap: 10%;
  }

  .logo-img {
    width: 70%; 
    height: 70%;
    display: none;
    place-items: center;
    transform: translateY(-15%);
  }
  
  .logo-img img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block;
  }

  .pip {
    width: 0.75em;
    height: 0.75em;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff 0%, #dfe6ff 35%, #b7c7ff 70%, #8ea3ff 100%);
    justify-self:center; align-self:center; box-shadow:0 0.125em 0.375em rgba(0,0,0,.35); display:none;
  }
  .pip:nth-child(1){ grid-area:1/1; } .pip:nth-child(2){ grid-area:1/2; } .pip:nth-child(3){ grid-area:1/3; }
  .pip:nth-child(4){ grid-area:2/1; } .pip:nth-child(5){ grid-area:2/2; } .pip:nth-child(6){ grid-area:2/3; }
  .pip:nth-child(7){ grid-area:3/1; } .pip:nth-child(8){ grid-area:3/2; } .pip:nth-child(9){ grid-area:3/3; }

  .face[data-n="1"] .pip:nth-child(5),
  .face[data-n="2"] .pip:nth-child(3), .face[data-n="2"] .pip:nth-child(7),
  .face[data-n="3"] .pip:nth-child(3), .face[data-n="3"] .pip:nth-child(5), .face[data-n="3"] .pip:nth-child(7),
  .face[data-n="4"] .pip:nth-child(1), .face[data-n="4"] .pip:nth-child(3), .face[data-n="4"] .pip:nth-child(7), .face[data-n="4"] .pip:nth-child(9),
  .face[data-n="5"] .pip:nth-child(1), .face[data-n="5"] .pip:nth-child(3), .face[data-n="5"] .pip:nth-child(5), .face[data-n="5"] .pip:nth-child(7), .face[data-n="5"] .pip:nth-child(9),
  .face[data-n="6"] .pip:nth-child(1), .face[data-n="6"] .pip:nth-child(3), .face[data-n="6"] .pip:nth-child(4), .face[data-n="6"] .pip:nth-child(6), .face[data-n="6"] .pip:nth-child(7), .face[data-n="6"] .pip:nth-child(9)
  { display:block }
  
  .face[data-n="6"] .pips { display: none; }
  .face[data-n="6"] .logo-img { display: grid; }

  .face,[data-n]{ transform-style:preserve-3d }
  /* La distancia de traslación es la mitad del tamaño de la cara (3.85em) */
  .face[data-n="1"]{ transform: translateZ(3.85em) } 
  .face[data-n="2"]{ transform: rotateY(90deg) translateZ(3.85em) } 
  .face[data-n="3"]{ transform: rotateY(180deg) translateZ(3.85em) } 
  .face[data-n="4"]{ transform: rotateY(-90deg) translateZ(3.85em) } 
  .face[data-n="5"]{ transform: rotateX(90deg) translateZ(3.85em) } 
  .face[data-n="6"]{ transform: rotateX(-90deg) translateZ(3.85em) } 
  
  .controls{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
  button{ appearance:none; border:0; cursor:pointer; background:linear-gradient(180deg, var(--btn), var(--btn-hover)); color:#fff; padding:12px 18px; border-radius:12px; font-weight:800; letter-spacing:.3px; box-shadow:0 8px 20px rgba(29,92,255,.35); }
  button:disabled{opacity:.6; cursor:not-allowed; box-shadow:none}
  .muted{ background:#24304a; color:#d6e1ff; box-shadow:none; font-weight:700 }
  .card{ background:var(--card); border:1px solid var(--edge); border-radius:16px; padding:20px; min-height:300px; }
  .badge{ display:inline-grid; place-items:center; min-width:28px; height:28px; padding: 0 6px; border-radius:8px; background:#1e2a45; color:#9fc1ff; font-weight:800; margin-right:8px; border:1px solid var(--edge); }
  h2{margin:0 0 6px; font-size:1.15rem}
  .author{color:var(--muted); margin:0 0 14px}
  .text p{ color:#eef3ff; line-height:1.7; text-align: justify; text-indent: 40px; margin: 0 0 1em; }
  .small{font-size:.875rem}
  footer{color:var(--muted); font-size:.875rem; text-align:center}

  /* Estilos para el título 2X1 */
  #title { 
    display: block; 
    line-height: 1.1; 
  }
  #title span[style] {
    font-size: 0.9em;
    font-weight: 400 !important;
    display: block;
    color: var(--fg);
    margin-top: 4px;
    letter-spacing: normal;
  }
  
  .text-dupla {
    margin-bottom: 25px; 
  }
  .text-dupla:not(:first-child) {
    border-top: 2px solid #1e2a45; 
    padding-top: 25px;
  }
  .text-dupla h3 {
    margin: 0 0 4px; 
    font-size: 1.1rem; 
    font-weight: 700;
  }
  .text-dupla .author {
    margin-bottom: 15px;
  }

</style>
</head>
<body>
  <main class="app" role="main">
    <header>
      <h1>Microrrelatos tirados al azar - Triple C </h1>
      <p>Apretá el botón y dejá que el azar te regale un microrrelato. También podés presionar <strong>R</strong> o sacudir el celular.</p>
    </header>
    <section class="stage" aria-label="Juego de azar">
      <div class="dice-wrap">
        <div class="dice-container">
          <div class="viewport" aria-hidden="true">
            <div class="shadow"></div>
            <div class="dice" id="dice1"></div>
          </div>
          <div class="viewport" aria-hidden="true">
            <div class="shadow"></div>
            <div class="dice" id="dice2"></div>
          </div>
          <div class="viewport" aria-hidden="true">
            <div class="shadow"></div>
            <div class="dice" id="dice3"></div>
          </div>
        </div>
        <div class="controls">
          <button id="rollBtn" aria-label="Lanzar los dados">¡Que la suerte te acompañe!</button>
          <button id="imgBtn" class="muted" disabled>Descargar imagen (IG)</button>
        </div>
      </div>
      <article class="card" id="card" aria-live="polite">
        <div class="small" style="margin-bottom:6px; color:var(--muted);">Suma total</div>
        <h2><span class="badge" id="badge">—</span><span id="title">Aún no has tirado los dados</span></h2>
        <p class="author" id="author">Cuando salga un número, verás aquí el texto correspondiente.</p>
        <div class="text" id="content"></div>
        </article>
    </section>
    <footer>© 2025 — Triple C · Antología Microrrelatos tirados al azar</footer>
  </main>
<script>
document.querySelectorAll('.dice').forEach(dice => {
    let facesHTML = '';
    for (let i = 1; i <= 6; i++) {
        facesHTML += `
            <div class="face" data-n="${i}">
                <span class="edge"></span>
                <div class="pips">${'<div class="pip"></div>'.repeat(9)}</div>
                <div class="logo-img"><img src="logotriplec.jpeg" alt="Logo Triple C"></div>
            </div>`;
    }
    dice.innerHTML = facesHTML;
});

/* —— Textos —— */
const pieces = [
  { n:3, stories: [{ title:"El Oráculo de Triple C", author:"Triple C", text: "La suerte está de tu lado. Has invocado al oráculo de Triple C. Al lanzar nuevamente los dados, se te otorgará un microrrelato relacionado con tu subconsciente." }] },
  { n:4, title:"AZAROSO", author:"ROQUE GRILLO", text: `Se lavó las manos y salió al patio. Colocó, sobre cada una de las cinco tumbas, las doradas cápsulas de bronce. Después entró en su biblioteca y dejó el Smith & Wesson. Se sirvió un vodka. Con ojos lacrimosos aceptó que ya no le quedaban amigos. Y también que ya no jugaría más a esa ruleta que le enseñara su abuelo Iván a orillas del Mar Negro.` },
  { n:5, stories: [
    { title:"ALMA", author:"CLAUDIA SÁNCHEZ", text: `Le ofrecieron una suma importante si el experimento funcionaba. Necesitaban el dinero, pero empezó a arrepentirse. Tarde. Su cuerpo ya no obedecía y su mente se cristalizaba. Yacía sobre una báscula con forma de cama, el frío corriéndole por las venas. Pensó en su esposa y su hijo, en el fin de sus penurias. Los médicos no entendían qué sucedía. El monitor titilaba: –21 g, luego 42 g, luego –63 g. El corazón era una línea recta. Las maniobras fallaron. El experimento fracasó. Al llevarlo a la morgue, entraban dos camillas más: su mujer y su hijo, fallecidos en un accidente.` },
    { title:"HOLY CRAPS!", author:"DÉBORA BENACOT", text: `Con la túnica arremangada hasta los codos (bendita sea la etiqueta casual pero maldito el calor infernal de este antro) y el brillo vicioso en las pupilas celestiales, los lanza otra vez. Su buena racha se mantiene. Qué genio eras, Albert, pero en esto te equivocaste: el susodicho no sólo juega a los dados, sino que los carga, aunque ningún crupier note el artilugio. De todos modos, también tiene acciones mayoritarias en el Casino de Almas. Es sabido que la casa siempre gana.` }
  ]},
  { n:6, title:"RESUMEN URGENTE", author:"PATRICIA NASELLO", text: `Apuesta, incluso, lo que le resulta imprescindible y cuando lo imprescindible se acaba, en cuanta covacha ilegal halla, apuesta lo ajeno. Una vez inmerso en esa fuerza que lo succiona, descubre que retener el trabajo, así como a la familia, es una tarea titánica para su energía ya escasa. Ahora, da vueltas dentro de un remolino sobre cuyas rocas punzantes del fondo, hasta el buen nombre pierde.
Y falta poco para que este mal que le arrebata el ánimo se extienda, e infecte con violencia la poca sangre libre de tormento que aún le resta.` },
  { n:7, title:"AZAR", author:"LEO MERCADO", text: `Estuvo toda la noche perdiendo guita en la ruleta. Toda la noche, sin excepción, como desde hacía mucho tiempo no pasaba. Solitario y sin corazonadas, apostaba a números inservibles o imaginarios y perdía. Cuando se le acabó el último centavo salió del garito enfurecido y veloz y se topó con ella, que tenía unos ojos infinitos, mirándolo fijamente. Pero como venía con la racha del perdedor tampoco se dio cuenta y siguió de largo.` },
  { n:8, stories: [
    { title:"LUDOPATÍA", author:"LORENA CITÓN", text: `Cuando el psicólogo informó su diagnóstico, negó suavemente con la cabeza, suspiró y con calma inquietante le dijo:\n—Apuesto a que estás equivocado.` },
    { title:"HOLY CRAPS!", author:"DÉBORA BENACOT", text: `Con la túnica arremangada hasta los codos (bendita sea la etiqueta casual pero maldito el calor infernal de este antro) y el brillo vicioso en las pupilas celestiales, los lanza otra vez. Su buena racha se mantiene. Qué genio eras, Albert, pero en esto te equivocaste: el susodicho no sólo juega a los dados, sino que los carga, aunque ningún crupier note el artilugio. De todos modos, también tiene acciones mayoritarias en el Casino de Almas. Es sabido que la casa siempre gana.` }
  ]},
  { n:9, title:"LA FORTUNA", author:"PABLO GONZ", text: `¿Quieres saber qué es la fortuna sin levantarte del sillón? Pues existe un método pero comporta cierto riesgo. Toma un dado grande. ¿Lo tienes? Si no lo tienes, suspende la lectura. ¿Ya tienes el dado? Bien, métetelo en la boca y cierra los labios. Mírate a un espejo y constata que pareces una persona normal. ¿OK? Estás preparado para empezar el ejercicio. Mueve la cabeza suavemente a la derecha y después a la izquierda. Luego repite el gesto seis veces, con mayor violencia cada vez. Si no se te rompe ningún diente, eso es la fortuna.` },
  { n:10, title:"SUERTE", author:"GUILLERMO IGLESIAS", text: `Ella tan profesional independiente, tan discreto Chanel o lo que sea. Tan Kerouac que imaginate, y alguna Pizarnik aunque me mate Tan Las Palabras y la Cosas y lento pinot gris oxigenado. Uno tan cerveza en palangana, tan bestia choripán que no se note. Ella departiendo amablemente y uno tan perdiéndose en su escote. Ella tanto cello en la penumbra y uno BB King alcoholizado. Ella tan mirá si no es divino inclinada sobre el tiesto señalado y uno sí, precioso y redondito (nunca logra mirar hacia otro lado). Tan no puede funcionar hacete cargo y sigue funcionando, sin embargo.` },
  { n:11, stories: [
    { title:"TENTACIONES", author:"DIANA RAQUEL HERNÁNDEZ", text: `Él me esperaba en un auto lujoso, me habló de los últimos sucesos en su vida: concluir el posgrado, casa y auto nuevos; todo lo que cualquiera pudiera desear. Habló de sus mujeres en mi ausencia. "¿Tú no me vas a contar nada? No me digas que te dio amnesia y ahora los negarás a todos ellos. Propuso detenernos a beber algo. Entramos a un hotel lujoso, nada que ver a con los que antes visité: un gran salón para parejas, todos con el aperitivo en la mano, el momento previo a escabullirse a una habitación. El juego de seducción no se hizo esperar. "No puedo aceptar. Tú eres el diablo, ¿verdad?".` },
    { title:"DESORGANIZADO", author:"CARO FERNÁNDEZ", text: `Apostó todo al número 22 en la quiniela matutina. Esa noche soñó con el loco.` }
  ]},
  { n:12, title:"HADO DE UN DÍA CUALQUIERA", author:"FERNANDO ECHENIQUE", text: `La ventana quedó apenas abierta y el viento esconde las entradas bajo la cama. Javier las busca desesperado, con sueño y lagañas, sin saber que esos boletos ya no son suyos, que la obra de esta noche no será para él. Sale tarde y pierde el micro. Sube al siguiente. Una mirada azul con zapatos rojos alegra su mañana. Coquetean, sonríen, se distrae. Suena el timbre y descubre que se pasó tres paradas. Baja apurado, voltea para mirarla una vez más sin escuchar el chillido. Tirado en el asfalto, mientras se desvanece, piensa en las ganas que tenía de ir a esa obra y mira los tacones rojos que lloran azul.` },
  { n:13, title:"LA PRIMERA PIEDRA", author:"JOSÉ MANUEL ORTÍZ SOTO", text: `No pensó en el dueño del almacén. Ni si éste contaba con un seguro contra actos vandálicos. O si había cámaras de vigilancia observándolo. Y menos en si él, en su próxima condición de bárbaro juvenil, tendría el tiempo suficiente para eludir a los gendarmes y sus porras. A Juanito solo le pareció irresistible cascar aquel cristal de una pedrada. Y así lo hizo.` },
  { n:14, title:"UN DETALLITO", author:"HERNÁN CHALO INDIVERI", text: `La final, la tenía ganada antes de clasificar, mis menús habían cautivado a 3 de los 4 jurados desde el comienzo del certamen. El plato con el que ganaría, hubiera sido “Bife de hígado de cerdo feliz, papas noisette del altiplano boliviano, finas hierbas, hummus de garbanzo kabuli con morrón asado”. El postre “Tres uvas a la miel vaporizada” sería el boom de la noche. En la semifinal, el azar puso mi nombre en el tazón del jurado envidioso. Buscó la mínima excusa para eliminarme. Suerte para él, que un coriandro, se le incrustó en la muela careada. Una simple semilla.` },
  { n:15, stories: [
    { title:"EL JUEGO DEL DESTINO", author:"JESÚS OLAGUE", text: `Aburridos, los dioses señalan a ciegas un lugar de la tierra y lanzan el dado del mal; a cada cara corresponde una catástrofe, así se suceden guerras, desastres, epidemias. El dado del bien se extravió hace miles de años; por más que la humanidad implore, los milagros ya no existen.` },
    { title:"COINCIDENCIA", author:"JUAN ROMAGNOLI", text: `Escribo la historia de Z:Z camina por la calle en una agradable tarde de verano. En una esquina se cruza con X y se detiene a conversar con él. X le comenta que ha leído una historia donde Z conversa con X en una esquina. Z expresa su asombro por la coincidencia\n—¿Qué coincidencia? —pregunta X\n—No lo sé...—duda Z, y se aleja desconcertado.` }
  ]},
  { n:16, title:"COINCIDENCIA", author:"JUAN ROMAGNOLI", text: `Escribo la historia de Z:Z camina por la calle en una agradable tarde de verano. En una esquina se cruza con X y se detiene a conversar con él. X le comenta que ha leído una historia donde Z conversa con X en una esquina. Z expresa su asombro por la coincidencia\n—¿Qué coincidencia? —pregunta X\n—No lo sé...—duda Z, y se aleja desconcertado.` },
  { n:17, title:"LA CASA SIEMPRE GANA", author:"JUAN MANUEL MONTES", text: `Toda la noche estuvo iluminado por un azar radiante. No quiso cometer viejos errores y fue directo a la caja. Un empleado lo felicitó y le ofreció una suite gratis. Sonrió al rechazar la trampa. Llegó al estacionamiento con un bolso repleto de efectivo. Allí, cada paso era una sombra, un eco. Caminó hacia su auto sintiéndose incómodo. Dentro, con el futuro pisándole los talones, respiró agitado. El corazón, en cambio, se le detuvo como una ruleta. Lo encontraron una semana después. Nadie reclamó el cuerpo. \nEl río sin cauce del dinero volvió a escurrirse en el casino.` },
  { n:18, stories: [{ title:"El Oráculo de Triple C", author:"Triple C", text: "La suerte está de tu lado. Has invocado al oráculo de Triple C. Al lanzar nuevamente los dados, se te otorgará un microrrelato relacionado con tu subconsciente." }] }
];
const byN = Object.fromEntries(pieces.map(p=>[p.n,p]));

let lastSum = 0;
let lastRolls = []; 
let isRolling = false;
const rollBtn = document.getElementById('rollBtn');
const imgBtn = document.getElementById('imgBtn');
const badge = document.getElementById('badge');
const titleEl = document.getElementById('title');
const authorEl = document.getElementById('author');
const contentEl = document.getElementById('content');
const sumDescription = document.querySelector('.small'); 

const dice1 = document.getElementById('dice1');
const dice2 = document.getElementById('dice2');
const dice3 = document.getElementById('dice3');
const allDice = [dice1, dice2, dice3];


function getRandomRolls() {
    let n1, n2, n3, sum;
    do {
        n1 = Math.floor(Math.random() * 6) + 1;
        n2 = Math.floor(Math.random() * 6) + 1;
        n3 = Math.floor(Math.random() * 6) + 1;
        sum = n1 + n2 + n3;
    } while (sum === lastSum);
    return { n1, n2, n3, sum };
}

function baseOrientation(n){ switch(n){ case 1: return 'rotateX(0deg) rotateY(0deg)'; case 2: return 'rotateY(-90deg)'; case 3: return 'rotateY(-180deg)'; case 4: return 'rotateY(90deg)'; case 5: return 'rotateX(-90deg)'; case 6: return 'rotateX(90deg)'; } }
function spinTo(n1, n2, n3){ const rolls = [n1, n2, n3]; allDice.forEach((dice, index) => { const n = rolls[index]; const turnsY = 360 * (2 + Math.floor(Math.random()*2)); const turnsX = 360 * (1 + Math.floor(Math.random()*2)); dice.style.transition = 'transform 1.05s cubic-bezier(.2,.7,.1,1)'; dice.style.transform = `rotateX(${turnsX}deg) rotateY(${turnsY}deg) ${baseOrientation(n)}`; }); }

function displayStoryContent(piece, sum) {
    const isDupla = Array.isArray(piece.stories) && piece.stories.length > 1;
    
    // 1. Set Title and Author based on Dupla, Oráculo or Single
    if (isDupla) {
        titleEl.innerHTML = '2X1 <span style="font-weight:400">¡Tu fortuna se duplicó! Ganaste dos textos en una sola tirada.</span>';
        authorEl.textContent = 'Microrrelatos: ' + piece.stories.map(s => s.title).join(' / ');
    } else if (sum === 3 || sum === 18) {
        titleEl.textContent = piece.stories[0].title;
        authorEl.textContent = piece.stories[0].author;
    } else {
        titleEl.textContent = piece.title;
        authorEl.textContent = piece.author;
    }
    
    // 2. Format Content
    let contentHTML = '';

    if (sum === 3 || sum === 18) { // Oráculo (Logo)
        contentHTML = `
            <img src="logotriplec.jpeg" alt="Logo Triple C" style="max-width: 100%; max-height: 200px; height: auto; display: block; margin: 0 auto 1em;">
            <p style="text-align: center; font-style: italic;">${piece.stories[0].text}</p>`;
    } else if (isDupla) {
        piece.stories.forEach((story) => {
            contentHTML += `
                <div class="text-dupla">
                    <h3>${story.title}</h3>
                    <p class="author">${story.author}</p>
                    ${story.text.split(/\n+/).map(par => `<p>${par}</p>`).join('')}
                </div>`;
        });
    } else { // Single Story
        contentHTML = piece.text
            .split(/\n+/)
            .map(par => `<p>${par}</p>`)
            .join('');
    }

    contentEl.innerHTML = contentHTML;
}


function reveal(rolls, sum){
    const p = byN[sum];
    if (!p) {
      console.error("No se encontró historia para la suma:", sum);
      return;
    }
    badge.textContent = sum;
    sumDescription.innerHTML = `Suma total: ${rolls[0]} + ${rolls[1]} + ${rolls[2]} =`;
    
    lastSum = sum;
    lastRolls = rolls;
    
    displayStoryContent(p, sum);
    
    imgBtn.disabled = false;
}

function roll(){ 
    if(isRolling) return; 
    isRolling = true; 
    rollBtn.disabled = true; 
    imgBtn.disabled = true; 
    
    // Obtener los rolls y la suma
    const { n1, n2, n3, sum } = getRandomRolls(); 

    // Girar los dados
    spinTo(n1, n2, n3); 
    
    setTimeout(()=>{ 
      // Mostrar el resultado de la suma (el texto)
      reveal([n1, n2, n3], sum); 
      isRolling = false; 
      rollBtn.disabled = false; 
    }, 1100); 
}


function wrapParagraph(ctx, text, maxWidth){ const words = text.split(/\s+/); const lines = []; let line = ''; for(const w of words){ const test = line ? line + ' ' + w : w; if(ctx.measureText(test).width <= maxWidth){ line = test; }else{ if(line) lines.push(line); line = w; } } if(line) lines.push(line); return lines.map((t,i)=>({ text:t, first:i===0, last:i===lines.length-1 })); }
function drawJustifiedLine(ctx, text, x, y, width){ const words = text.split(/\s+/); if(words.length <= 1){ ctx.fillText(text, x, y); return; } const totalWordsWidth = words.reduce((acc,w)=> acc + ctx.measureText(w).width, 0); const gaps = words.length - 1; const spaceWidth = ctx.measureText(' ').width; const extra = (width - totalWordsWidth - spaceWidth*gaps) / gaps; let xx = x; for(let i=0;i<words.length;i++){ const w = words[i]; ctx.fillText(w, xx, y); if(i<gaps) xx += ctx.measureText(w).width + spaceWidth + Math.max(extra,0); } }

async function renderImageFor(piece, currentSum, rolls) {
    const W=1080, H=1350, PAD=96;
    const canvas = document.createElement('canvas');
    canvas.width=W;
    canvas.height=H;
    const ctx = canvas.getContext('2d');
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#0f1730');
    g.addColorStop(.6,'#121b36');
    g.addColorStop(1,'#0b0f17');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);
    ctx.strokeStyle = 'rgba(255,255,255,.08)';
    ctx.lineWidth = 4;
    ctx.strokeRect(2,2,W-4,H-4);
    
    const family='system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    const INDENT = 40;
    const X=PAD, CW=W-PAD*2; 
    let y=PAD;
    const isOraculo = currentSum === 3 || currentSum === 18;
    const isDupla = Array.isArray(piece.stories) && piece.stories.length > 1;

    // 1. Mostrar la suma en la parte superior
    let titleSize = 64;
    ctx.fillStyle='#9fb2d9';
    ctx.font=`600 28px ${family}`;
    const sumText = `Suma total: ${rolls[0]} + ${rolls[1]} + ${rolls[2]} = ${currentSum}`;
    ctx.fillText(sumText, X, y);
    y += 28 * 2;
    
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';

        img.onload = () => {
            if (isOraculo) {
                // Lógica de Oráculo
                const imgWidth = 800;
                const imgHeight = (img.height / img.width) * imgWidth;
                const x = (W - imgWidth) / 2;
                const yDraw = y + 50; 
                ctx.drawImage(img, x, yDraw, imgWidth, imgHeight);
                y = yDraw + imgHeight + 50;
                
                ctx.fillStyle='#eaf2ff';
                ctx.font=`400 36px ${family}`;
                ctx.textAlign = 'center';
                ctx.fillText(piece.stories[0].text, W/2, y + 40);
                ctx.textAlign = 'left';

            } else if (isDupla) {
                // Lógica de Dupla
                let bodySize = 34; // Tamaño inicial para el cuerpo de la Dupla
                const PADDING_BETWEEN_STORIES = 60;
                
                // Cálculo del tamaño de fuente que cabe en la tarjeta
                while(true){
                    let totalHeightNeeded = 0;
                    ctx.font=`400 ${bodySize}px ${family}`;
                    
                    // Altura del encabezado 2X1
                    totalHeightNeeded += titleSize * 1.15; // 2X1
                    totalHeightNeeded += 36 * 1.5;        // Subtítulo
                    totalHeightNeeded += 32 * 1.5;        // Microrrelatos:

                    // Altura de los textos
                    for(let i=0; i<piece.stories.length; i++){
                        const story = piece.stories[i];
                        
                        // Title and Author
                        totalHeightNeeded += bodySize * 1.2; // Título (approx)
                        totalHeightNeeded += bodySize * 1.35; // Autor (approx)
                        
                        // Body text
                        for(const para of story.text.split(/\n+/)){
                            const ls = wrapParagraph(ctx, para, CW - INDENT);
                            totalHeightNeeded += ls.length * bodySize * 1.35;
                            totalHeightNeeded += bodySize * 0.7; // Para gap
                        }

                        // Separator
                        if (i < piece.stories.length - 1) {
                            totalHeightNeeded += PADDING_BETWEEN_STORIES;
                        }
                    }
                    
                    const needed = y + totalHeightNeeded + PAD;
                    if(needed <= H || bodySize <= 22) break; // Límite mínimo
                    bodySize -= 1;
                }
                
                // Dibujar Encabezado 2X1
                ctx.fillStyle='#eaf2ff'; 
                ctx.font=`700 ${titleSize}px ${family}`;
                ctx.fillText('2X1', X, y+titleSize); 
                y += titleSize*1.15;
                
                ctx.fillStyle='#9fb2d9'; 
                ctx.font=`400 36px ${family}`;
                ctx.fillText('¡Tu fortuna se duplicó! Ganaste dos textos en una sola tirada.', X, y+36); 
                y += 36*1.5;
                
                ctx.fillStyle='#9fb2d9';
                ctx.font=`600 32px ${family}`;
                ctx.fillText('MICRORRELATOS:', X, y+32); y += 32*1.5;

                // Dibujar Dupla
                for(let i=0; i<piece.stories.length; i++){
                    const story = piece.stories[i];

                    // 1. Title and Author
                    ctx.fillStyle='#eaf2ff'; 
                    ctx.font=`700 ${bodySize*1.1}px ${family}`;
                    ctx.fillText(story.title, X, y + bodySize*1.1); y += bodySize*1.2;
                    
                    ctx.fillStyle='#9fb2d9'; 
                    ctx.font=`600 ${bodySize}px ${family}`;
                    ctx.fillText(story.author.toUpperCase(), X, y + bodySize); y += bodySize*1.35;

                    // 2. Body Text
                    ctx.fillStyle='#eef3ff';
                    ctx.font=`400 ${bodySize}px ${family}`;
                    
                    for(const para of story.text.split(/\n+/)){
                        const lines = wrapParagraph(ctx, para, CW - INDENT);
                        for(const L of lines){
                            const x0 = X + (L.first ? INDENT : 0);
                            const usable = CW - (L.first ? INDENT : 0);
                            const yLine = y + bodySize;
                            if(!L.last && L.text.includes(' ')){
                                drawJustifiedLine(ctx, L.text, x0, yLine, usable);
                            }else{
                                ctx.fillText(L.text, x0, yLine);
                            }
                            y += bodySize*1.35;
                        }
                        y += bodySize*0.7; // Paragraph gap
                    }

                    // 3. Separator
                    if (i < piece.stories.length - 1) {
                        ctx.strokeStyle = 'rgba(255,255,255,.15)';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(X + 50, y);
                        ctx.lineTo(W - PAD - 50, y);
                        ctx.stroke();
                        y += PADDING_BETWEEN_STORIES;
                    }
                }
            } else {
                // Lógica de Historia Individual (Single Story)
                let authorSize=38, bodySize=44;

                ctx.fillStyle='#eaf2ff'; ctx.font=`700 ${titleSize}px ${family}`;
                const titleLines = wrapParagraph(ctx, piece.title, CW);
                for(const L of titleLines){ ctx.fillText(L.text, X, y+titleSize); y += titleSize*1.15; }
                
                y += 18; 
                ctx.fillStyle='#9fb2d9'; ctx.font=`600 ${authorSize}px ${family}`;
                ctx.fillText(piece.author.toUpperCase(), X, y+authorSize); y += authorSize*1.35;
                
                ctx.fillStyle='#eef3ff';
                let linesMeta;
                while(true){
                  ctx.font=`400 ${bodySize}px ${family}`;
                  linesMeta = [];
                  for(const para of piece.text.split(/\n+/)){
                    const ls = wrapParagraph(ctx, para, CW - INDENT);
                    linesMeta.push(...ls, { text:'', first:false, last:true, isGap:true });
                  }
                  if(linesMeta.length && linesMeta[linesMeta.length-1].isGap) linesMeta.pop();
                  const needed = y + linesMeta.reduce((acc,l)=> acc + (l.isGap ? bodySize*0.7 : bodySize*1.35), 0) + PAD;
                  if(needed <= H || bodySize <= 28) break;
                  bodySize -= 2;
                }
                
                for(const L of linesMeta){
                  if(L.isGap){ y += bodySize*0.7; continue; }
                  const x0 = X + (L.first ? INDENT : 0);
                  const usable = CW - (L.first ? INDENT : 0);
                  const yLine = y + bodySize;
                  if(!L.last && L.text.includes(' ')){
                    drawJustifiedLine(ctx, L.text, x0, yLine, usable);
                  }else{
                    ctx.fillText(L.text, x0, yLine);
                  }
                  y += bodySize*1.35;
                }
            }

            // Footer (Se aplica a todos los casos)
            const footer='Triple C · Que la suerte te acompañe';
            ctx.font=`600 28px ${family}`; ctx.fillStyle='rgba(255,255,255,.55)';
            const fw = ctx.measureText(footer).width; 
            ctx.fillText(footer, W - PAD - fw, H - PAD * 0.6);
            
            canvas.toBlob(blob => resolve(blob), 'image/png');
        };
        img.onerror = () => reject(new Error("Error al cargar la imagen del logo."));
        img.src = "logotriplec.jpeg";
    });
}

async function saveImage(){
    const p = byN[lastSum];
    if(!p) return;

    // Determina el nombre del archivo
    let fileName = '';
    if (lastSum === 3 || lastSum === 18) {
        fileName = 'Triple_C_Oraculo.png';
    } else if (Array.isArray(p.stories) && p.stories.length > 1) {
        const safeTitle = p.stories[0].title.replace(/[^\w\-]+/g,'_');
        fileName = `${safeTitle}_Dupla.png`;
    } else {
        const safeTitle = p.title.replace(/[^\w\-]+/g,'_');
        fileName = `${safeTitle}.png`;
    }
    
    try {
        const blob = await renderImageFor(p, lastSum, lastRolls); 
        if(blob){
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        } else {
            console.error("No se pudo generar la imagen para descargar.");
        }
    } catch (error) {
        console.error("Error al generar la imagen: ", error);
    }
}


rollBtn.addEventListener('click', roll);
document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='r') roll(); });
imgBtn.addEventListener('click', saveImage);
let lastShake=0;
if('DeviceMotionEvent' in window){ window.addEventListener('devicemotion', (e)=>{ const a=e.accelerationIncludingGravity; if(!a) return; const intensity=Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z); const now=Date.now(); if(intensity>35 && now-lastShake>1200){ lastShake=now; roll(); } }, {passive:true}); }
</script>
</body>
</html>